<!DOCTYPE html>
<html>
<head>
    <title>DronoBoy - С плавными и атакующими мишенями</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            text-shadow: 2px 2px 4px black;
        }
        #ammo, #score, #timer, #health { font-size: 24px; }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
        }
        #start-button {
            padding: 10px 20px;
            font-size: 20px;
            background: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.1s;
        }
        #start-button:active {
            transform: scale(0.95);
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="hud">
        <div id="ammo">Патроны: 300</div>
        <div id="score">Очки: 0</div>
        <div id="timer">Время: 999</div>
        <div id="health">Здоровье: 100</div>
    </div>
    <div id="crosshair"></div>
    <div id="start-screen">
        <button id="start-button">Начать игру</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>

    <script>
        const DronoBoy = (() => {
            const config = {
                playerHeight: 1.7,
                gunPosition: { x: 0.4, y: -0.5, z: -1.35 },
                gunScale: 0.9,
                targetCount: 12,
                targetSpeed: 0.09,
                ammoStart: 300,
                targetSize: 0.5,
                spawnDistance: { min: -120, max: -80 },
                despawnDistance: 100,
                fadeDistance: 60,
                targetHeight: {
                    min: 1.7,
                    max: 30
                },
                gameDuration: 999,
                playerHealth: 100,
                attackerChance: 0.3,
                waveMotionChance: 0.7,
                attackDistance: 1, // Дистанция для начала атаки
                attackHeight: 1.0   // Высота атаки (уровень игрока)
            };

            let scene, camera, renderer, controls;
            let gun, targets = [];
            let ammoCount = config.ammoStart, score = 0, health = config.playerHealth, gameTime = config.gameDuration;
            let isGameStarted = false, gameInterval;

            function init() {
                createScene();
                setupCamera();
                setupRenderer();
                createLighting();
                createGround();
                loadModels();
                setupControls();
                setupEventListeners();
                animate();
            }

            function createScene() {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
            }

            function setupCamera() {
                camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.y = config.playerHeight;
            }

            function setupRenderer() {
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('game-container').appendChild(renderer.domElement);
            }

            function createLighting() {
                const ambientLight = new THREE.AmbientLight(0x404040);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(1, 1, 1);
                scene.add(ambientLight, directionalLight);
            }

            function createGround() {
                const ground = new THREE.Mesh(
                    new THREE.PlaneGeometry(1000, 1000),
                    new THREE.MeshStandardMaterial({ color: 0x3a5f0b })
                );
                ground.rotation.x = -Math.PI / 2;
                scene.add(ground);
            }

            function loadModels() {
                const loader = new THREE.GLTFLoader();
                
                // Загрузка оружия
                loader.load('https://cdn.jsdelivr.net/gh/mrdoob/three.js/examples/models/gltf/duck/duck.gltf', 
                    (gltf) => {
                        gun = gltf.scene;
                        gun.position.set(config.gunPosition.x, config.gunPosition.y, config.gunPosition.z);
                        gun.scale.set(config.gunScale, config.gunScale, config.gunScale);
                        gun.rotation.y = Math.PI;
                        camera.add(gun);
                        scene.add(camera);
                    },
                    undefined,
                    () => {
                        gun = new THREE.Mesh(
                            new THREE.BoxGeometry(0.3, 0.1, 0.5),
                            new THREE.MeshStandardMaterial({ color: 0x555555 })
                        );
                        gun.position.set(config.gunPosition.x, config.gunPosition.y, config.gunPosition.z);
                        camera.add(gun);
                        scene.add(camera);
                    }
                );

                // Создание мишеней
                for (let i = 0; i < config.targetCount; i++) {
                    spawnNewTarget();
                }
            }

            function spawnNewTarget() {
                const geometry = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 8);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0
                });
                
                const target = new THREE.Mesh(geometry, material);
                
                // Позиция
                target.position.set(
                    Math.random() * 60 - 30,
                    Math.random() * (config.targetHeight.max - config.targetHeight.min) + config.targetHeight.min,
                    Math.random() * (config.spawnDistance.max - config.spawnDistance.min) + config.spawnDistance.min
                );
                
                // Свойства мишени
                target.userData = {
                    isTarget: true,
                    fadingIn: true,
                    speed: config.targetSpeed * (0.8 + Math.random() * 0.4),
                    isAttacker: Math.random() < config.attackerChance,
                    points: 10,
                    waveMotion: Math.random() < config.waveMotionChance,
                    initialY: target.position.y
                };
                
                if (target.userData.isAttacker) {
                    target.userData.speed *= 1.5;
                    target.userData.diveSpeed = 0.05;
                    target.userData.points = 20;
                }
                
                targets.push(target);
                scene.add(target);
            }

            function setupControls() {
                controls = new THREE.PointerLockControls(camera, renderer.domElement);
                
                document.getElementById('start-button').addEventListener('click', () => {
                    controls.lock().catch(e => {
                        alert("Разрешите блокировку курсора для игры!");
                    });
                });

                controls.addEventListener('lock', () => {
                    if (!isGameStarted) {
                        startGame();
                    }
                    isGameStarted = true;
                    document.getElementById('start-screen').style.display = 'none';
                });

                controls.addEventListener('unlock', () => {
                    isGameStarted = false;
                    document.getElementById('start-screen').style.display = 'flex';
                });
            }

            function startGame() {
                resetGame();
                gameInterval = setInterval(updateGame, 1000);
            }

            function resetGame() {
                // Очистка старых мишеней
                targets.forEach(target => scene.remove(target));
                targets = [];
                
                // Сброс параметров
                ammoCount = config.ammoStart;
                score = 0;
                health = config.playerHealth;
                gameTime = config.gameDuration;
                
                // Создание новых мишеней
                for (let i = 0; i < config.targetCount; i++) {
                    spawnNewTarget();
                }
                
                // Обновление HUD
                updateHUD();
                
                // Остановка старого таймера
                if (gameInterval) clearInterval(gameInterval);
            }

            function endGame() {
                isGameStarted = false;
                controls.unlock();
                clearInterval(gameInterval);
                document.getElementById('start-screen').style.display = 'flex';
            }

            function updateGame() {
                if (!isGameStarted) return;
                
                gameTime--;
                document.getElementById('timer').textContent = `Время: ${gameTime}`;
                
                if (gameTime <= 0 || health <= 0) {
                    endGame();
                }
            }

            function setupEventListeners() {
                window.addEventListener('resize', onWindowResize);
                document.addEventListener('mousedown', onMouseDown);
                document.addEventListener('keydown', onKeyDown);
            }

            function shoot() {
                if (ammoCount <= 0 || !isGameStarted) return;
                
                ammoCount--;
                updateHUD();
                
                // Эффект выстрела
                if (gun) {
                    gun.position.z += 0.1;
                    setTimeout(() => gun.position.z -= 0.1, 100);
                }
                
                // Создание луча
                const raycaster = new THREE.Raycaster(
                    camera.position,
                    camera.getWorldDirection(new THREE.Vector3())
                );
                
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                for (const intersect of intersects) {
                    if (intersect.object.userData.isTarget) {
                        const target = intersect.object;
                        
                        // Удаляем мишень
                        scene.remove(target);
                        targets = targets.filter(t => t !== target);
                        
                        // Увеличиваем счет
                        score += target.userData.points;
                        updateHUD();
                        
                        // Создаем новую мишень
                        spawnNewTarget();
                        
                        return;
                    }
                }
            }

            function takeDamage(amount) {
                health -= amount;
                if (health < 0) health = 0;
                updateHUD();
                
                if (health <= 0) {
                    endGame();
                }
            }

            function reload() {
                ammoCount = config.ammoStart;
                updateHUD();
            }

            function updateHUD() {
                document.getElementById('ammo').textContent = `Патроны: ${ammoCount}`;
                document.getElementById('score').textContent = `Очки: ${score}`;
                document.getElementById('health').textContent = `Здоровье: ${health}`;
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function onMouseDown(e) {
                if (e.button === 0 && isGameStarted) shoot();
            }

            function onKeyDown(e) {
                if (e.key === 'r') reload();
            }

            function animate() {
                requestAnimationFrame(animate);
                
                targets.forEach(target => {
                    // Движение вперед
                    target.position.z += target.userData.speed;
                    
                    // Волнообразное движение
                    if (target.userData.waveMotion) {
                        target.position.y = target.userData.initialY + Math.sin(target.position.z * 0.1) * 2;
                    }
                    
                    // Атака на игрока
                    if (target.userData.isAttacker && target.position.z > -config.attackDistance) {
                        // Плавное снижение до уровня игрока
                        if (target.position.y > config.attackHeight) {
                            target.position.y -= target.userData.diveSpeed;
                        }
                        
                        // Проверка столкновения с игроком
                        const distanceToPlayer = Math.sqrt(
                            Math.pow(target.position.x - camera.position.x, 2) +
                            Math.pow(target.position.z - camera.position.z, 2)
                        );
                        
                        if (distanceToPlayer < 2 && target.position.y < config.playerHeight + 1) {
                            takeDamage(10);
                            scene.remove(target);
                            targets = targets.filter(t => t !== target);
                            spawnNewTarget();
                            return;
                        }
                    }
                    
                    // Плавное появление
                    if (target.userData.fadingIn && target.position.z < config.spawnDistance.max + config.fadeDistance) {
                        const fadeProgress = Math.min(1, (target.position.z - config.spawnDistance.max) / config.fadeDistance);
                        target.material.opacity = fadeProgress;
                        if (fadeProgress >= 1) {
                            target.userData.fadingIn = false;
                        }
                    }
                    
                    // Плавное исчезновение
                    if (target.position.z > config.despawnDistance - config.fadeDistance) {
                        const fadeProgress = 1 - Math.min(1, (target.position.z - (config.despawnDistance - config.fadeDistance)) / config.fadeDistance);
                        target.material.opacity = fadeProgress;
                    }
                    
                    // Удаление мишени
                    if (target.position.z > config.despawnDistance) {
                        scene.remove(target);
                        targets = targets.filter(t => t !== target);
                        spawnNewTarget();
                    }
                });

                renderer.render(scene, camera);
            }

            return { init };
        })();

        window.onload = DronoBoy.init;
    </script>
</body>
</html>