<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parking Rush</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #000;
    }
    #game-container {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <script>
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 800,
      parent: 'game-container',
      scene: {
        preload: preload,
        create: create,
        update: update
      },
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 0 },
          debug: false
        }
      },
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
      }
    };

    const game = new Phaser.Game(config);

    // Размеры сцены
    const sceneWidth = 800;
    const sceneHeight = 800;

    // Функции для перевода относительных координат
    function relX(x) {
      return x * sceneWidth;
    }

    function relY(y) {
      return y * sceneHeight;
    }

    function relSize(size) {
      return size * Math.min(sceneWidth, sceneHeight);
    }

    // Смещения в относительных единицах
    const grassOffsetX = 0.0125; // 10 пикселей / 800 = 0.0125
    const grassOffsetY = 0.025; // 20 пикселей / 800 = 0.025

    const treeOffsetX = 0.05625; // 45 пикселей / 800 = 0.05625
    const treeOffsetY = 0.04375; // 35 пикселей / 800 = 0.04375

    const bushOffsetX = 0.04375; // 35 пикселей / 800 = 0.04375
    const bushOffsetY = 0.03125; // 25 пикселей / 800 = 0.03125

    const oilOffsetX = 0.01875; // 15 пикселей / 800 = 0.01875
    const oilOffsetY = 0.02875; // 23 пикселей / 800 = 0.02875

    // Относительные координаты парковочных мест (левый верхний блок)
    const upperLeftParkingSpots = [
      { x: 0.18, y: 0.19 }, // Первое место
      { x: 0.227, y: 0.19 }, // Второе место
      { x: 0.273, y: 0.19 }, // Третье место
      { x: 0.32, y: 0.19 }, // Четвертое место
      { x: 0.365, y: 0.19 }, // Пятое место
      { x: 0.412, y: 0.19 }, // Шестое место
    ];

    // Относительные координаты парковочных мест (правый верхний блок)
    const upperRightParkingSpots = [
      { x: 0.547, y: 0.19 }, // Первое место
      { x: 0.595, y: 0.19 }, // Второе место
      { x: 0.64, y: 0.19 }, // Третье место
      { x: 0.685, y: 0.19 }, // Четвертое место
      { x: 0.731, y: 0.19 }, // Пятое место
      { x: 0.778, y: 0.19 }, // Шестое место,
    ];

    // Объединяем все парковочные места
    const allParkingSpots = [...upperLeftParkingSpots, ...upperRightParkingSpots];

    // Масштабируем координаты парковочных мест
    const scaledParkingSpots = allParkingSpots.map(spot => ({
      x: relX(spot.x),
      y: relY(spot.y),
    }));

    // Маршруты для NPC (относительные координаты)
    const npcRoutes = allParkingSpots.map(spot => {
      const x = relX(spot.x);
      const y = relY(spot.y);
      return [
        { x, y }, // Парковочное место
        { x, y: y - relY(0.025) }, // Выезд с парковочного места (начало)
        { x, y: y - relY(0.05) }, // Выезд с парковочного места (конечная высота)
        { x: relX(0.875), y: y - relY(0.05) }, // Движение вправо
        { x: relX(0.875), y: relY(0.875) }, // Движение вниз
        { x: relX(0.125), y: relY(0.875) }, // Движение влево
        { x: relX(0.125), y: y - relY(0.05) }, // Движение вверх
        { x, y: y - relY(0.05) }, // Подъезд к парковочному месту (начало)
        { x, y: y - relY(0.025) }, // Подъезд к парковочному месту (близко)
        { x, y }  // Заезд на парковочное место (очень близко)
      ];
    });

    let npcs = []; // Массив для хранения NPC
    const npcSpeed = 100; // Скорость NPC по дороге
    const npcParkingSpeed = 30; // Скорость NPC при выезде/заезде на парковочное место

    function preload() {
      // Загрузка изображений
      this.load.image('background', 'assets/parking_map.png'); // Фон парковки
      this.load.image('entrance', 'assets/entrance.png'); // Въезд
      this.load.image('pavilion', 'assets/pavilion.png'); // Павильон
      this.load.image('grass1', 'assets/grass1.png'); // Трава 1
      this.load.image('tree1', 'assets/tree1.png'); // Дерево 1
      this.load.image('bush1', 'assets/bush1.png'); // Куст 1
      this.load.image('oil', 'assets/oil.png'); // Масляное пятно
      this.load.image('npcCar', 'assets/npc_car.png'); // NPC автомобиль
    }

    function create() {
      // Очистка сцены от всех объектов
      this.children.each(child => {
        child.destroy();
      });

      // Добавление фона
      const background = this.add.image(relX(0.5), relY(0.5), 'background');
      background.setDisplaySize(sceneWidth, sceneHeight);

      // Добавление невидимых парковочных мест
      createInvisibleParkingSpots(this);

      // Добавление невидимых дорог
      createInvisibleRoads(this);

      // Добавление въезда и павильона
      createEntranceAndPavilion(this);

      // Создание декоративного слоя
      createDecorativeLayer(this);

      // Создание NPC для каждого парковочного места
      npcs = scaledParkingSpots.map((spot, index) => {
        const npc = this.physics.add.sprite(spot.x, spot.y, 'npcCar').setScale(0.5);
        npc.setCollideWorldBounds(true);

        // Назначаем маршрут
        npc.route = npcRoutes[index];
        npc.routeIndex = 0;

        // Добавляем состояние ожидания
        npc.isWaiting = true;

        // Случайная задержка перед началом движения (от 1 до 5 секунд)
        const delay = Phaser.Math.Between(1000, 5000); // Задержка в миллисекундах
        this.time.delayedCall(delay, () => {
          npc.isWaiting = false; // Завершаем ожидание
          moveNPCToNextPoint(npc); // Начинаем движение
        }, [], this);

        return npc;
      });
    }

    function update() {
      // Обновление движения NPC
      npcs.forEach(npc => {
        if (!npc.isWaiting) { // Если NPC не в состоянии ожидания
          const target = npc.route[npc.routeIndex];
          const distance = Phaser.Math.Distance.Between(npc.x, npc.y, target.x, target.y);

          if (distance < 5) { // Если NPC близко к точке
            npc.routeIndex++;

            // Если NPC завершил маршрут
            if (npc.routeIndex >= npc.route.length) {
              // Останавливаем NPC на парковочном месте
              npc.setVelocity(0, 0); // Сбрасываем скорость
              npc.routeIndex = 0; // Сбрасываем индекс маршрута

              // Выравниваем NPC строго перпендикулярно дороге (угол 0 градусов)
              npc.rotation = 0; // 0 градусов (перпендикулярно дороге)

              // Добавляем задержку перед повторным выездом
              npc.isWaiting = true;
              const delay = Phaser.Math.Between(1000, 5000); // Задержка в миллисекундах
              this.time.delayedCall(delay, () => {
                npc.isWaiting = false; // Завершаем ожидание
                moveNPCToNextPoint(npc); // Начинаем движение
              }, [], this);
            } else {
              // Продолжаем движение к следующей точке
              moveNPCToNextPoint(npc);
            }
          }
        }
      });
    }

    function moveNPCToNextPoint(npc) {
      const target = npc.route[npc.routeIndex];
      const angle = Phaser.Math.Angle.Between(npc.x, npc.y, target.x, target.y);

      // Расстояние до парковочного места (последняя точка маршрута)
      const parkingSpot = npc.route[npc.route.length - 1];
      const distanceToParkingSpot = Phaser.Math.Distance.Between(npc.x, npc.y, parkingSpot.x, parkingSpot.y);

      // Замедление, если NPC находится на последних этапах маршрута и в радиусе 50 пикселей от парковочного места
      const isParkingMovement = (
        npc.routeIndex >= npc.route.length - 3 && // Последние 3 точки маршрута
        distanceToParkingSpot <= 50 // Расстояние до парковочного места меньше 50 пикселей
      );
      const speed = isParkingMovement ? npcParkingSpeed : npcSpeed;

      // Устанавливаем скорость и поворот NPC
      npc.setVelocity(Math.cos(angle) * speed, Math.sin(angle) * speed);
      npc.rotation = angle + Math.PI / 2;
    }

    function createInvisibleParkingSpots(scene) {
      // Добавляем невидимые парковочные места
      scaledParkingSpots.forEach(spot => {
        const parkingSpot = scene.add.rectangle(
          spot.x, spot.y,
          relSize(0.03), // Ширина (3% от сцены)
          relSize(0.0425), // Высота (4.25% от сцены)
          0x000000, // Цвет (чёрный, но невидимый)
          0 // Прозрачность (0 = полностью прозрачный)
        ).setOrigin(0.5);

        // Добавляем физику для парковочного места
        scene.physics.add.existing(parkingSpot, true); // Статический объект
      });
    }

    function createInvisibleRoads(scene) {
      // Координаты и размеры дорог (относительные)
      const roads = [
        // Въезд
        { x: 0.126, y: 0.4465, width: 0.126, height: 0.108 }, // Центр въезда

        // Левая вертикальная дорога
        { x: 0.1275, y: 0.118, width: 0.052, height: 0.7645 }, // Центр дороги

        // Правая вертикальная дорога
        { x: 0.809, y: 0.1185, width: 0.06, height: 0.763 }, // Центр дороги

        // Верхняя горизонтальная дорога
        { x: 0.1285, y: 0.117, width: 0.7425, height: 0.0715 }, // Центр дороги

        // Нижняя горизонтальная дорога
        { x: 0.1295, y: 0.811, width: 0.7395, height: 0.0705 }, // Центр дороги

        // Центральная горизонтальная дорога
        { x: 0.1285, y: 0.436, width: 0.741, height: 0.126 }, // Центр дороги

        // Центральная вертикальная дорога
        { x: 0.4435, y: 0.118, width: 0.1015, height: 0.764 }, // Центр дороги

        // Внутренний верхний проезд
        { x: 0.1295, y: 0.2895, width: 0.7385, height: 0.047 }, // Центр внутреннего верхнего проезда

        // Внутренний нижний проезд
        { x: 0.1295, y: 0.663, width: 0.7385, height: 0.047 } // Центр внутреннего нижнего проезда
      ];

      roads.forEach(road => {
        const x = relX(road.x);
        const y = relY(road.y);
        const width = relX(road.width);
        const height = relY(road.height);

        const roadRect = scene.add.rectangle(
          x, y,
          width, height,
          0x000000, // Цвет (чёрный, но невидимый)
          0 // Прозрачность (0 = полностью прозрачный)
        ).setOrigin(0.5);

        // Добавляем физику для дороги
        scene.physics.add.existing(roadRect, true); // Статический объект
      });
    }

    function createEntranceAndPavilion(scene) {
      // Въезд
      const entranceX = relX(0.126);
      const entranceY = relY(0.4465);
      scene.add.image(entranceX, entranceY, 'entrance').setScale(0.5);

      // Павильон
      const pavilionX = relX(0.35);
      const pavilionY = relY(0.05);
      scene.add.image(pavilionX, pavilionY, 'pavilion').setScale(0.5);
    }

    function createDecorativeLayer(scene) {
      // Масштабирование координат для декоративных элементов
      const grass1Coords = {
        x: relX(0.3305) + relX(grassOffsetX), // Трава 1
        y: relY(0.0445) + relY(grassOffsetY)
      };
      const tree1Coords = {
        x: relX(0.8175) + relX(treeOffsetX), // Дерево 1
        y: relY(0.0635) + relY(treeOffsetY)
      };
      const bush1Coords = {
        x: relX(0.858) + relX(bushOffsetX), // Куст 1
        y: relY(0.149) + relY(bushOffsetY)
      };
      const oilCoords = {
        x: relX(0.0125) + relX(oilOffsetX), // Масляное пятно
        y: relY(0.469) + relY(oilOffsetY)
      };

      // Добавление декоративных элементов с масштабированными координатами
      const grass1 = scene.add.image(grass1Coords.x, grass1Coords.y, 'grass1').setScale(0.5); // Трава 1
      const tree1 = scene.add.image(tree1Coords.x, tree1Coords.y, 'tree1').setScale(0.5); // Дерево 1
      const bush1 = scene.add.image(bush1Coords.x, bush1Coords.y, 'bush1').setScale(0.5); // Куст 1
      const oil = scene.add.image(oilCoords.x, oilCoords.y, 'oil').setScale(0.5); // Масляное пятно

      // Установка глубины для декоративных элементов
      grass1.setDepth(10);
      tree1.setDepth(10);
      bush1.setDepth(10);
      oil.setDepth(2);
    }
  </script>
</head>
<body>
  <div id="game-container"></div>
</body>
</html>